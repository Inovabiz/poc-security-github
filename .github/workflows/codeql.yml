# ========================================
# Workflow de GitHub Advanced Security - CodeQL
# ========================================
# Este workflow realiza análisis estático de código para detectar vulnerabilidades
# y problemas de calidad usando GitHub Advanced Security (GHAS)

name: "CodeQL"

# ========================================
# TRIGGERS: Cuándo se ejecuta este workflow
# ========================================
on:
  # Se ejecuta automáticamente en Pull Requests hacia master o main
  pull_request:
    branches: [ "master", "main" ]
  
  # Se ejecuta en un schedule (programado)
  schedule:
    - cron: '0 2 * * 1'    # Todos los lunes a las 2am UTC (análisis periódico)

# ========================================
# JOB 1: Análisis de Código con CodeQL
# ========================================
jobs:
  analyze:
    name: Analyze ${{ matrix.language }} for security and quality
    runs-on: ubuntu-latest
    
    # Permisos necesarios para CodeQL Advanced Security
    permissions:
      actions: read           # Leer actions del workflow
      contents: read          # Leer contenido del repositorio
      security-events: write  # Escribir eventos de seguridad (alertas)

    # Estrategia de matriz: permite ejecutar el análisis para múltiples lenguajes
    strategy:
      fail-fast: false  # Continúa aunque falle el análisis de un lenguaje
      matrix:
        # Define los lenguajes a analizar en este proyecto
        language: [ 'javascript-typescript']
        # 'javascript-typescript' analiza ambos lenguajes en un solo job
        # Otros lenguajes disponibles: 'python', 'cpp', 'csharp', 'go', 'java', 'ruby', 'swift'

    # ========================================
    # PASOS DEL ANÁLISIS CodeQL
    # ========================================
    steps:
      # PASO 1: Obtener el código fuente del repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # PASO 2: Inicializar CodeQL
      # Configura el ambiente de análisis y descarga las queries de seguridad
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          # +security-and-quality: Ejecuta queries de SEGURIDAD Y CALIDAD
          # Detecta: SQL injection, XSS, command injection, credenciales hardcodeadas, etc.
          queries: +security-and-quality

      # PASO 3: Autobuild
      # CodeQL construye automáticamente el proyecto si es necesario
      # Para JavaScript/TypeScript generalmente no requiere compilación
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      # PASO 4: Realizar el Análisis
      # Ejecuta las queries de CodeQL y genera el reporte de seguridad
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          # Categoriza los resultados por lenguaje para mejor organización
          category: "/language:${{ matrix.language }}"

  # ========================================
  # JOB 2: Auto-asignación de Reviewers
  # ========================================
  # Este job se ejecuta en paralelo y asigna automáticamente revisores al PR
  reviewers:
    name: "Auto-request reviewers on PRs to master/main"
    
    # Solo se ejecuta si este workflow fue disparado por un PR hacia master/main
    if: github.event_name == 'pull_request' && (github.base_ref == 'master' || github.base_ref == 'main')
    runs-on: ubuntu-latest
    
    # Permiso para modificar Pull Requests (agregar reviewers)
    permissions:
      pull-requests: write
    
    steps:
      # Usa GitHub CLI (gh) para agregar un reviewer automáticamente
      - name: Request reviewers
        env:
          # GITHUB_TOKEN: Token de autenticación generado AUTOMÁTICAMENTE por GitHub Actions
          # - NO requiere configuración manual ni creación de secrets
          # - Se crea por detrás en cada ejecución del workflow
          # - Actúa en nombre de 'github-actions[bot]', no de ningún usuario específico
          # - Es temporal y expira al finalizar el workflow
          # - Los permisos están limitados por la sección 'permissions' del job
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}  # Número del PR actual
          REPO: ${{ github.repository }}                  # Repositorio en formato owner/repo
        run: |
          # Comando: gh pr edit agrega el reviewer al PR
          gh pr edit $PR_NUMBER --repo $REPO --add-reviewer Nflores95

